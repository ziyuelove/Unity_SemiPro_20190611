--Author : Administrator
--Date   : 2018/11/20

--声明，这里声明了类名还有属性，并且给出了属性的初始值。
talkboxPage = {}

--这句是重定义元表的索引，就是说有了这句，这个才是一个类。
talkboxPage.__index = talkboxPage
talkboxPage.gameobect = nil

talkboxPage.talkData = nil;

--构造体，构造体的名字是随便起的，习惯性改为New()
function talkboxPage:New() 
    local self = {};    --初始化self，如果没有这句，那么类所建立的对象改变，其他对象都会改变
    setmetatable(self, talkboxPage);  --将self的元表设定为Class
    return self;    --返回自身
end

function talkboxPage:LuaInit(LuaTable)
	self.LuaTable = LuaTable;
end

--开始时调用
function talkboxPage:Start(gameobject) 
	self.gameobect = gameobject;
	self.gameobect.transform.localScale = Vector3.New(1,1,1);
	self.gameobect.transform.localPosition = Vector3.New(0,0,0);
	--print(LoginPage.gameobect.name.." runing");
	self.BtnList = self.gameobect.transform:Find("OperBtnList");
	self.Text_talk = self.gameobect.transform:Find("Image/Text"):GetComponent("Text");
	self.Text_name = self.gameobect.transform:Find("Image/name"):GetComponent("Text");
	self.Image_Head = self.gameobect.transform:Find("head"):GetComponent("Image");
	local Btn_Next = self.gameobect.transform:Find("NextBtn");
	--print(Btn_Enter.name.." Find");

	EventTriggerListener.Get(Btn_Next.gameObject).OnClickCall = "OnNext";
	EventTriggerListener.Get(Btn_Next.gameObject):OnSetLuaTable(self.LuaTable);
	game.OpenPage = true;
	self:Init();
	gamectrl.bctrl = false;
	return gameobject;
end

function talkboxPage:OnClose(gameobject)
	game.OpenPage = false;
	--self:QuestOper();
	UnityEngine.GameObject.Destroy(self.gameobect);
	gamectrl.bctrl = true;
	gamectrl.selectNPC = nil;
	if talkmaneger.CurTalkData.events ~=nil then
		for key, value in pairs(talkmaneger.CurTalkData.events) do   
			if value.type == 1 then
				--添加任务
				questmaneger.add(value.event);
			elseif value.type == 2 then
				--删除任务
				questmaneger.del(value.event);
			elseif value.type == 4 then
				--删除道具
				itemmaneger.delItem(value.event,value.num)
			elseif value.type == 5 then
				--删除NPC
				sceneNpcManager.DelNpc(value.event);
			end
		end
	end
	--self.QuestID = nil;
	return gameobject;
end

function talkboxPage:OnNext(gameobject)
	self:OnClose(nil);
	talkmaneger.NextTalk();
	return gameobject;
end

function talkboxPage:Update()
end


function talkboxPage:Init()
	self.Text_name.text = talkmaneger.CurTalkData.name;
	self.Text_talk.text = talkmaneger.CurTalkData.text;

	local spriteImage = ResourceManager.GetInstance():LoadSprite("Texture/rolehead/"..talkmaneger.CurTalkData.head);
	if spriteImage~=nil then
		self.Image_Head.sprite  = spriteImage;
	else
		self.Image_Head.gameObject:SetActive(false)
	end

	if talkmaneger.CurTalkData.events ~=nil then
		local pos = 1;
		local Pos_Y = 0;
		for key, value in pairs(talkmaneger.CurTalkData.events) do   
			if value.type == 0 then
				local ItemRes = ResourceManager.GetInstance():Load("Prefab/UI/ItemUI/npctalkbtn");
				local item = UnityEngine.GameObject.Instantiate(ItemRes);
				item.transform:SetParent(self.BtnList.transform);
				item.transform.localPosition = Vector3.New(0,Pos_Y,0);
				item.transform:Find("Text"):GetComponent("Text").text = value.text;
				item.name = pos;
				EventTriggerListener.Get(item).OnClickCall = "OnSelectEvent";
				EventTriggerListener.Get(item):OnSetLuaTable(self.LuaTable);
				pos = pos + 1;
				Pos_Y = Pos_Y + 90;
			end
		end
	end
end

function talkboxPage:OnSelectEvent(gameobject)
	local index = tonumber(gameobject.name);
	local eventdata = talkmaneger.CurTalkData.events[index];
	if eventdata.type == 0 then
		self:OnClose(nil);
		talkmaneger.StartTalk(eventdata.event);  --跳转剧情对话
	end
	return gameobject;
end

function talkboxPage.Show()
	game.OpenUI("UI/talkboxPage");
	--talkboxPage.talkData = talkData;
end

return talkboxPage

--endregion
