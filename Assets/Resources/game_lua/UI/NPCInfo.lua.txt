--Author : Administrator
--Date   : 2018/11/20

--声明，这里声明了类名还有属性，并且给出了属性的初始值。
NPCInfo = {}

--这句是重定义元表的索引，就是说有了这句，这个才是一个类。
NPCInfo.__index = NPCInfo
NPCInfo.gameobect = nil

--构造体，构造体的名字是随便起的，习惯性改为New()
function NPCInfo:New() 
    local self = {};    --初始化self，如果没有这句，那么类所建立的对象改变，其他对象都会改变
    setmetatable(self, NPCInfo);  --将self的元表设定为Class
    return self;    --返回自身
end

function NPCInfo:LuaInit(LuaTable)
	self.LuaTable = LuaTable;
end

--开始时调用
function NPCInfo:Start(gameobject) 
	game.OpenPage = true
	self.gameobect = gameobject;
	self.gameobect.transform.localScale = Vector3.New(1,1,1);
	self.gameobect.transform.localPosition = Vector3.New(0,0,0);
	self.itemlist = {};
	local Btn_close = self.gameobect.transform:Find("close") 
	EventTriggerListener.Get(Btn_close.gameObject).OnClickCall = "OnClose";
	EventTriggerListener.Get(Btn_close.gameObject):OnSetLuaTable(self.LuaTable);
	self.Scroll_list = self.gameobect.transform:Find("NPCScroll/Viewport/Content");

	self:Refresh()
	return gameobject;
end

function NPCInfo:OnClose(gameobject)
	game.OpenPage = false
	UnityEngine.GameObject.Destroy(self.gameobect);
	return gameobject;
end

function NPCInfo:Refresh()
	self:ClearItems();
	for key, npc in pairs(npcInfoList) do  
		self:CreateItem(npc)
	end 
end


function NPCInfo:CreateItem(itemData)
	local ItemRes = ResourceManager.GetInstance():Load("Prefab/UI/ItemUI/NPCItem");
	local item = UnityEngine.GameObject.Instantiate(ItemRes);
	item.transform:SetParent(self.Scroll_list.transform);
	item.name = itemData.id;

	item.transform:Find("Name"):GetComponent("Text").text = itemData.name;
	local spriteImage = ResourceManager.GetInstance():LoadSprite("Texture/rolehead/"..itemData.id);
	item.transform:Find("NPCImage"):GetComponent("Image").sprite = spriteImage;

	local npcValue = playerdatamaneger.findNPCGive(itemData.id);
	if npcValue~=nil then
		item.transform:Find("GiveValue"):GetComponent("Text").text = npcValue.value;
	else
		item.transform:Find("GiveValue"):GetComponent("Text").text = 0;
	end
	item.gameObject:AddComponent(typeof(ScrollViewEventTrigger));
	item.gameObject:GetComponent("ScrollViewEventTrigger"):SetEventCall(self.LuaTable,"SelectItem");
	table.insert (self.itemlist,item);
end

function NPCInfo:ClearItems()
	if self.itemlist~=nil then
		for key, value in pairs(self.itemlist) do   
			UnityEngine.GameObject.Destroy(value.gameObject);
		end
	end
	self.selectBtn = nil;
	self.itemlist = {}
end

function NPCInfo:SelectItem(gameobject)

	return 	gameobject;
end


function NPCInfo.Update()
end

return NPCInfo

--endregion
